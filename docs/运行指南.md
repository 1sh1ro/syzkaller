# syzkaller å¢å¼ºè¦†ç›–ç‡å¯¼å‘æ¨¡ç³Šæµ‹è¯•ç³»ç»Ÿ - è¿è¡ŒæŒ‡å—

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å‰ç½®è¦æ±‚

1. **Go ç¯å¢ƒ** (ç‰ˆæœ¬ 1.19+)
   ```bash
   go version  # ç¡®è®¤ Go ç‰ˆæœ¬
   ```

2. **Linux å†…æ ¸æºç ** (ç”¨äºæµ‹è¯•ç›®æ ‡)
   ```bash
   # ä¸‹è½½å†…æ ¸æºç 
   git clone https://github.com/torvalds/linux.git
   cd linux
   ```

3. **QEMU** (ç”¨äºè™šæ‹Ÿæœº)
   ```bash
   # Ubuntu/Debian
   sudo apt-get install qemu-system-x86

   # CentOS/RHEL
   sudo yum install qemu-kvm
   ```

## ğŸ“¦ ç¼–è¯‘ç³»ç»Ÿ

### 1. ç¼–è¯‘ syzkaller

```bash
# è¿›å…¥ syzkaller ç›®å½•
cd syzkaller-master

# ç¼–è¯‘æ‰€æœ‰ç»„ä»¶
make

# æˆ–è€…å•ç‹¬ç¼–è¯‘å„ç»„ä»¶
make manager    # ç¼–è¯‘ç®¡ç†å™¨
make fuzzer     # ç¼–è¯‘æ¨¡ç³Šæµ‹è¯•å™¨
make executor   # ç¼–è¯‘æ‰§è¡Œå™¨
make syz-ci     # ç¼–è¯‘ CI å·¥å…·
```

### 2. éªŒè¯ç¼–è¯‘ç»“æœ

```bash
# æ£€æŸ¥ç¼–è¯‘äº§ç‰©
ls -la bin/
# åº”è¯¥çœ‹åˆ°ï¼š
# syz-manager
# syz-fuzzer  
# syz-executor
# syz-ci
# ç­‰æ–‡ä»¶
```

### 3. è¿è¡Œæµ‹è¯•éªŒè¯

```bash
# è¿è¡Œè¯„åˆ†ç³»ç»Ÿå•å…ƒæµ‹è¯•
cd pkg/fuzzer
go test -v -run TestScoreTracker
go test -v -run TestWeightedSelector
go test -v -run TestKernelLogMatcher

# è¿è¡Œæ€§èƒ½æµ‹è¯•
go test -v -run TestScoreSystemPerformance
go test -bench=BenchmarkScoreCalculation

# è¿è¡Œé›†æˆæµ‹è¯•
go test -v -run TestEndToEndScoring
```

## âš™ï¸ é…ç½®ç³»ç»Ÿ

### 1. åˆ›å»ºé…ç½®æ–‡ä»¶

åˆ›å»º `config.json` æ–‡ä»¶ï¼š

```json
{
    "target": "linux/amd64",
    "http": "127.0.0.1:56741",
    "workdir": "./workdir",
    "kernel_obj": "/path/to/linux",
    "image": "./stretch.img",
    "sshkey": "./stretch.id_rsa",
    "syzkaller": "./bin",
    "procs": 8,
    "type": "qemu",
    "vm": {
        "count": 4,
        "kernel": "/path/to/linux/arch/x86/boot/bzImage",
        "cpu": 2,
        "mem": 2048
    },
    "scoring": {
        "enabled": true,
        "coverage_weight": 0.4,
        "rarity_weight": 0.3,
        "kernel_log_weight": 0.2,
        "time_anomaly_weight": 0.1,
        "max_score_cache": 10000,
        "time_window_size": 1000,
        "weighted_select_prob": 0.3
    },
    "enable_syscalls": [
        "openat",
        "read",
        "write",
        "close",
        "mmap"
    ]
}
```

### 2. å‡†å¤‡è™šæ‹Ÿæœºé•œåƒ

```bash
# ä¸‹è½½æˆ–åˆ›å»º Debian é•œåƒ
wget https://storage.googleapis.com/syzkaller/stretch.img
wget https://storage.googleapis.com/syzkaller/stretch.id_rsa

# è®¾ç½®æƒé™
chmod 600 stretch.id_rsa
```

### 3. ç¼–è¯‘å†…æ ¸

```bash
cd /path/to/linux

# ä½¿ç”¨ syzkaller æ¨èçš„å†…æ ¸é…ç½®
wget https://raw.githubusercontent.com/google/syzkaller/master/dashboard/config/linux/bits/kasan.config
wget https://raw.githubusercontent.com/google/syzkaller/master/dashboard/config/linux/bits/kcov.config

# åˆå¹¶é…ç½®
cat kasan.config kcov.config >> .config
make olddefconfig

# ç¼–è¯‘å†…æ ¸
make -j$(nproc)
```

## ğŸƒâ€â™‚ï¸ è¿è¡Œç³»ç»Ÿ

### 1. å¯åŠ¨ syzkaller ç®¡ç†å™¨

```bash
# å¯åŠ¨ç®¡ç†å™¨
./bin/syz-manager -config=config.json

# æˆ–è€…å¯ç”¨è¯¦ç»†æ—¥å¿—
./bin/syz-manager -config=config.json -debug
```

### 2. ç›‘æ§è¿è¡ŒçŠ¶æ€

æ‰“å¼€æµè§ˆå™¨è®¿é—®ï¼š`http://127.0.0.1:56741`

æ‚¨å°†çœ‹åˆ°ï¼š
- æ¨¡ç³Šæµ‹è¯•ç»Ÿè®¡ä¿¡æ¯
- å‘ç°çš„å´©æºƒæŠ¥å‘Š
- **æ–°å¢ï¼šè¯„åˆ†ç³»ç»Ÿç»Ÿè®¡**
- è¦†ç›–ç‡ä¿¡æ¯

### 3. è¯„åˆ†ç³»ç»Ÿç‰¹æœ‰ç›‘æ§

åœ¨ Web ç•Œé¢ä¸­ï¼Œæ‚¨å¯ä»¥çœ‹åˆ°æ–°å¢çš„è¯„åˆ†ç³»ç»Ÿä¿¡æ¯ï¼š

- **è¯„åˆ†åˆ†å¸ƒå›¾è¡¨**ï¼šæ˜¾ç¤ºç¨‹åºè¯„åˆ†çš„åˆ†å¸ƒæƒ…å†µ
- **åŠ æƒé€‰æ‹©ç»Ÿè®¡**ï¼šæ˜¾ç¤ºåŸºäºè¯„åˆ†é€‰æ‹©çš„æ¯”ä¾‹
- **å„ç»´åº¦è¯„åˆ†è¶‹åŠ¿**ï¼šè¦†ç›–ç‡ã€ç¨€æœ‰æ€§ã€å†…æ ¸æ—¥å¿—ã€æ—¶é—´å¼‚å¸¸çš„è¯„åˆ†è¶‹åŠ¿
- **é«˜åˆ†ç¨‹åºåˆ—è¡¨**ï¼šå½“å‰è¯„åˆ†æœ€é«˜çš„ç¨‹åº

## ğŸ”§ é«˜çº§é…ç½®

### 1. è°ƒæ•´è¯„åˆ†æƒé‡

æ ¹æ®æ‚¨çš„æµ‹è¯•ç›®æ ‡è°ƒæ•´æƒé‡ï¼š

```json
{
    "scoring": {
        "enabled": true,
        // é‡ç‚¹å…³æ³¨è¦†ç›–ç‡
        "coverage_weight": 0.6,
        "rarity_weight": 0.2,
        "kernel_log_weight": 0.1,
        "time_anomaly_weight": 0.1
    }
}
```

æˆ–è€…é‡ç‚¹å…³æ³¨å†…æ ¸æ—¥å¿—ï¼š

```json
{
    "scoring": {
        "enabled": true,
        // é‡ç‚¹å…³æ³¨å†…æ ¸å¼‚å¸¸
        "coverage_weight": 0.2,
        "rarity_weight": 0.2,
        "kernel_log_weight": 0.5,
        "time_anomaly_weight": 0.1
    }
}
```

### 2. æ€§èƒ½è°ƒä¼˜

```json
{
    "scoring": {
        "enabled": true,
        // å¢åŠ ç¼“å­˜æé«˜æ€§èƒ½
        "max_score_cache": 20000,
        // å¢å¤§æ—¶é—´çª—å£æé«˜ç»Ÿè®¡å‡†ç¡®æ€§
        "time_window_size": 2000,
        // é™ä½åŠ æƒé€‰æ‹©æ¦‚ç‡å‡å°‘è®¡ç®—å¼€é”€
        "weighted_select_prob": 0.2
    }
}
```

### 3. è°ƒè¯•æ¨¡å¼

å¯ç”¨è¯¦ç»†æ—¥å¿—æŸ¥çœ‹è¯„åˆ†è¿‡ç¨‹ï¼š

```json
{
    "debug": true,
    "scoring": {
        "enabled": true,
        "debug_scoring": true
    }
}
```

## ğŸ“Š ç»“æœåˆ†æ

### 1. æŸ¥çœ‹è¯„åˆ†ç»Ÿè®¡

```bash
# é€šè¿‡ HTTP API è·å–è¯„åˆ†ç»Ÿè®¡
curl http://127.0.0.1:56741/api/scoring/metrics

# è·å–é«˜åˆ†ç¨‹åº
curl http://127.0.0.1:56741/api/scoring/top-programs?limit=10
```

### 2. åˆ†ææ—¥å¿—

```bash
# æŸ¥çœ‹è¯„åˆ†ç›¸å…³æ—¥å¿—
grep "ç¨‹åºè¯„åˆ†" workdir/manager.log
grep "åŠ æƒé€‰æ‹©" workdir/manager.log
grep "smash å®Œæˆ" workdir/manager.log
```

### 3. æ€§èƒ½åˆ†æ

```bash
# æŸ¥çœ‹è¯„åˆ†è®¡ç®—æ€§èƒ½
grep "è¯„åˆ†è®¡ç®—æ—¶é—´" workdir/manager.log

# æŸ¥çœ‹å†…å­˜ä½¿ç”¨æƒ…å†µ
grep "è¯„åˆ†ç¼“å­˜" workdir/manager.log
```

## ğŸ› æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

1. **ç¼–è¯‘é”™è¯¯**
   ```bash
   # ç¡®ä¿ Go ç‰ˆæœ¬æ­£ç¡®
   go version
   
   # æ¸…ç†å¹¶é‡æ–°ç¼–è¯‘
   make clean
   make
   ```

2. **è¯„åˆ†ç³»ç»Ÿæœªå¯ç”¨**
   ```bash
   # æ£€æŸ¥é…ç½®æ–‡ä»¶
   grep -A 10 "scoring" config.json
   
   # æŸ¥çœ‹å¯åŠ¨æ—¥å¿—
   grep "è¯„åˆ†ç³»ç»Ÿ" workdir/manager.log
   ```

3. **è™šæ‹Ÿæœºå¯åŠ¨å¤±è´¥**
   ```bash
   # æ£€æŸ¥ QEMU å®‰è£…
   qemu-system-x86_64 --version
   
   # æ£€æŸ¥é•œåƒæ–‡ä»¶æƒé™
   ls -la stretch.img stretch.id_rsa
   ```

4. **å†…æ ¸ç¼–è¯‘é—®é¢˜**
   ```bash
   # æ£€æŸ¥å†…æ ¸é…ç½®
   grep CONFIG_KCOV /path/to/linux/.config
   grep CONFIG_KASAN /path/to/linux/.config
   
   # é‡æ–°é…ç½®å†…æ ¸
   make menuconfig
   ```

### æ€§èƒ½é—®é¢˜è¯Šæ–­

```bash
# ç›‘æ§ç³»ç»Ÿèµ„æºä½¿ç”¨
top -p $(pgrep syz-manager)

# æŸ¥çœ‹è¯„åˆ†ç³»ç»Ÿæ€§èƒ½æŒ‡æ ‡
curl http://127.0.0.1:56741/api/scoring/performance
```

## ğŸ“ˆ æ•ˆæœéªŒè¯

### 1. å¯¹æ¯”æµ‹è¯•

è¿è¡Œä¸¤ä¸ªå®ä¾‹è¿›è¡Œå¯¹æ¯”ï¼š

```bash
# å¯ç”¨è¯„åˆ†ç³»ç»Ÿçš„å®ä¾‹
./bin/syz-manager -config=config-with-scoring.json -workdir=./workdir-scoring

# ç¦ç”¨è¯„åˆ†ç³»ç»Ÿçš„å®ä¾‹  
./bin/syz-manager -config=config-without-scoring.json -workdir=./workdir-baseline
```

### 2. å…³é”®æŒ‡æ ‡å¯¹æ¯”

- **å´©æºƒå‘ç°é€Ÿåº¦**ï¼šå•ä½æ—¶é—´å†…å‘ç°çš„å´©æºƒæ•°é‡
- **ä»£ç è¦†ç›–ç‡å¢é•¿**ï¼šè¦†ç›–ç‡æå‡é€Ÿåº¦
- **é«˜ä»·å€¼è¾“å…¥æ¯”ä¾‹**ï¼šè§¦å‘å†…æ ¸å¼‚å¸¸çš„è¾“å…¥æ¯”ä¾‹
- **èµ„æºåˆ©ç”¨æ•ˆç‡**ï¼šCPU å’Œå†…å­˜ä½¿ç”¨æ•ˆç‡

### 3. ç”Ÿæˆå¯¹æ¯”æŠ¥å‘Š

```bash
# ä½¿ç”¨å†…ç½®å·¥å…·ç”ŸæˆæŠ¥å‘Š
./bin/syz-ci -config=config.json -mode=report -workdir1=./workdir-scoring -workdir2=./workdir-baseline
```

## ğŸ”„ æŒç»­è¿è¡Œ

### 1. ç³»ç»ŸæœåŠ¡é…ç½®

åˆ›å»º systemd æœåŠ¡æ–‡ä»¶ `/etc/systemd/system/syzkaller.service`ï¼š

```ini
[Unit]
Description=syzkaller å¢å¼ºæ¨¡ç³Šæµ‹è¯•ç³»ç»Ÿ
After=network.target

[Service]
Type=simple
User=syzkaller
WorkingDirectory=/home/syzkaller/syzkaller-master
ExecStart=/home/syzkaller/syzkaller-master/bin/syz-manager -config=/home/syzkaller/config.json
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

å¯ç”¨æœåŠ¡ï¼š

```bash
sudo systemctl enable syzkaller
sudo systemctl start syzkaller
sudo systemctl status syzkaller
```

### 2. æ—¥å¿—è½®è½¬

é…ç½® logrotate `/etc/logrotate.d/syzkaller`ï¼š

```
/home/syzkaller/syzkaller-master/workdir/*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    copytruncate
}
```

### 3. ç›‘æ§è„šæœ¬

åˆ›å»ºç›‘æ§è„šæœ¬ `monitor.sh`ï¼š

```bash
#!/bin/bash

# æ£€æŸ¥ syzkaller è¿›ç¨‹
if ! pgrep -f syz-manager > /dev/null; then
    echo "syzkaller è¿›ç¨‹æœªè¿è¡Œï¼Œæ­£åœ¨é‡å¯..."
    systemctl restart syzkaller
fi

# æ£€æŸ¥è¯„åˆ†ç³»ç»ŸçŠ¶æ€
SCORE_STATUS=$(curl -s http://127.0.0.1:56741/api/scoring/status | jq -r '.enabled')
if [ "$SCORE_STATUS" != "true" ]; then
    echo "è¯„åˆ†ç³»ç»Ÿæœªå¯ç”¨ï¼Œè¯·æ£€æŸ¥é…ç½®"
fi

# æ£€æŸ¥ç£ç›˜ç©ºé—´
DISK_USAGE=$(df /home/syzkaller | tail -1 | awk '{print $5}' | sed 's/%//')
if [ $DISK_USAGE -gt 80 ]; then
    echo "ç£ç›˜ä½¿ç”¨ç‡è¿‡é«˜: ${DISK_USAGE}%"
fi
```

è®¾ç½®å®šæ—¶ä»»åŠ¡ï¼š

```bash
# æ·»åŠ åˆ° crontab
*/5 * * * * /home/syzkaller/monitor.sh
```

## ğŸ“š æ›´å¤šèµ„æº

- [syzkaller å®˜æ–¹æ–‡æ¡£](https://github.com/google/syzkaller/tree/master/docs)
- [Linux å†…æ ¸æ¨¡ç³Šæµ‹è¯•æŒ‡å—](https://www.kernel.org/doc/html/latest/dev-tools/kunit/index.html)
- [KASAN ä½¿ç”¨æŒ‡å—](https://www.kernel.org/doc/html/latest/dev-tools/kasan.html)
- [KCOV è¦†ç›–ç‡å·¥å…·](https://www.kernel.org/doc/html/latest/dev-tools/kcov.html)

## ğŸ’¡ æœ€ä½³å®è·µ

1. **é€æ­¥å¯ç”¨**ï¼šå…ˆåœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯ï¼Œå†éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
2. **æƒé‡è°ƒä¼˜**ï¼šæ ¹æ®å®é™…æµ‹è¯•æ•ˆæœè°ƒæ•´å„ç»´åº¦æƒé‡
3. **å®šæœŸç›‘æ§**ï¼šå…³æ³¨è¯„åˆ†åˆ†å¸ƒå’Œç³»ç»Ÿæ€§èƒ½æŒ‡æ ‡
4. **æ—¥å¿—åˆ†æ**ï¼šå®šæœŸåˆ†ææ—¥å¿—ï¼Œä¼˜åŒ–é…ç½®å‚æ•°
5. **ç‰ˆæœ¬ç®¡ç†**ï¼šä¿å­˜ä¸åŒé…ç½®çš„æµ‹è¯•ç»“æœï¼Œä¾¿äºå¯¹æ¯”åˆ†æ

é€šè¿‡ä»¥ä¸Šæ­¥éª¤ï¼Œæ‚¨å°±å¯ä»¥æˆåŠŸè¿è¡Œè¿™ä¸ªå¢å¼ºçš„ syzkaller ç³»ç»Ÿï¼Œå¹¶ä½“éªŒåŸºäºè¯„åˆ†çš„æ™ºèƒ½æ¨¡ç³Šæµ‹è¯•åŠŸèƒ½ï¼